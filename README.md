# ログ解析システムの作成

## はじめに

コマンドライン上で対話的に操作することのできる、「wikipediaのログ解析システム」を作成しました。  
以下のページに開発の足跡を記載しています。  
https://troubled-event-601.notion.site/23d465c59ef380539620cbd826e5b9f2?pvs=74

## 作成したもの
作成したログ解析システムについて簡単に紹介します。  
web上に公開されているwikipediaのログファイルを使用して、1時間あたりのドメインコードのアクセス数を検索するシステムを作成しました。今回は次の２つの機能を実装しました。

**1. 人気記事の検索**  
指定したドメインコードの人気ランキングと閲覧数を検索できる機能を作りました。例えばドメインコードが「ja」（ja.wikipedia.org）の人気記事トップ３を検索したりすることができます。

**2. 総閲覧数の検索**  
指定したドメインコードの総閲覧数を検索できる機能を作りました。例えばドメインコード「ja」と「en」の総閲覧数を検索することができます。

なお、今回使用したwikipdeiaのログファイルについて詳しく知りたい場合は以下の公式ホームページを参照ください。  
https://wikitech.wikimedia.org/wiki/Data_Platform/Data_Lake/Traffic/Pageviews

## 使用した技術
環境構築はdockerを用いて行いました。  
システムはPHPとMySQLを連動させることで動作させています（PHPの拡張機能であるPDOを用いることで実現しました）。

## 使用方法

> [!WARNING]
> このシステムを利用するには**docker**が必要になります。また以下の操作は**Linux環境**にて実行してください。

### 1. セットアップ
ローカルの任意の場所にクローンしたら、まずは解析したいログファイルをproject1/src/log_filesディレクトリ下に**1件のみ**格納してください。
ログファイルはこちらのページからダウンロードできます：https://dumps.wikimedia.org/other/pageviews/


次にproject1ディレクトリ下に移動し、以下のコマンドを実行して環境構築（dockerのイメージ生成とコンテナの作成・起動）を行います。

dockerイメージのビルド
```
docker compose build
```

dockerコンテナの作成・起動
```
docker compose up -d
```

### 2. システムの起動と実行 
コンテナが立ち上がったらappコンテナ内へ以下のコマンドでアクセスします。
```
docker compose exec app bash
```

そして以下のコマンドを入力してログ解析システムを起動させます。
```
php src/analysis.php
```

> [!WARNING]
> 以下のようなメッセージが表示された場合はdbコンテナが起動しているか確認してください。
> ```
> 接続失敗: SQLSTATE[HY000] [2002] Connection refused
> ```
> ※ exitコマンドでappコンテナの外に出たうえで以下のコマンドを実行するとコンテナの起動を確認できます。
> ```
> docker compose ps
> ```
> 起動している場合は少し時間をおいて再度appコンテナ内に入ってコマンドを実行してください。
> dbコンテナが起動していない場合は下記のコマンドを実行して再度イメージ作成からやり直してください。
> ```
> doker compose down -v
> ```

起動するとこのような画面が立ち上がります（初回のみデータの取り込み作業が行われます）
```
接続成功
データの保管場所を作成しています...
作成完了
ログデータをデータベースに登録中です...(処理に数分かかります)
登録完了

以下の機能を実行できます
1. 指定したドメインコードの人気記事を検索する
2. 指定したドメインコードの合計ページ閲覧数を表示する
9. 終了する

番号を入力してください：
```

1（半角英数字）を入力すると指定したドメインコードの人気記事とその閲覧数を検索できます。  
例えばドメインコード「ja」の人気トップ５の記事を調べたいときには「ja 5」（ドメインコードと指定したいランキングとの間に半角スペースを入れるのを忘れないように）と入力します。そしてEnterキーを押すと検索が実行されます。
```
ja 5
メインページ, 11990
特別:検索, 2689
七人の侍, 1517
内山夕実, 1416
小林裕介, 795
```

2（半角英数字）を入力すると指定したドメインコードの総閲覧数を検索できます。
例えばドメインコードが「ja」と「en」の総閲覧数を調べたいときには「ja en」（ドメインコード間に半角スペースを入れるのを忘れないように）と入力します。そしてEnterキーを押すと検索が実行されます。
```
ja en
en, 2499863
ja, 416302
```

### 3. ログ解析システムの停止
使用し終わってログ解析システムを停止させたい場合はコンテナ外に出たのち以下のコマンドを実行します。
```
docker compose stop
```

### 4. ログ解析システムの削除
もうログ解析システムを使わない、という場合は以下の手順で削除することができます。

**1. dockerイメージの削除**  
以下のコマンドでログ解析システム実行に必要な環境の削除を行います。
```
docker compose down -v
```

さらにdockerイメージの削除も行います。以下のコマンドを実行するとイメージの一覧が表示されます。
```
docker image ls
```

実行結果はこのように表示されます。
```
REPOSITORY           TAG          IMAGE ID       CREATED        SIZE
project1-app         latest       4cf197022d79   2 hours ago    727MB
project1-db          latest       eeae7ea0e3ea   7 days ago     1.07GB
```

このうちの「project1-app」と「project1-db」はログ解析システム使用によって生成されたものなので削除を行います。以下のコマンドのように該当のイメージIDを指定することで削除できます。
```
docker image rm 4cf197022d79 eeae7ea0e3ea
```
**2. ファイルの削除**  
以下のコマンドでログ解析システムの関連コードをすべて削除します。一部、削除に権限が必要なファイルが含まれていることがあるのでsudoでの削除をおススメします。
```
sudo rm -rf project1
```

以上の手順でログ解析システムを完全に削除することができます。

### トラブルシューティング
システムを起動させてデータを取り込む際にエラーが発生した場合には以下の要因が考えられます。  

**・ログファイルを配置する前にdockerイメージの生成を行った**  
ログファイルを配置する前にdockerイメージを生成するとシステムが正常に動作しません。必ずsrc/log_filesディレクトリ下にファイルを格納してからイメージの生成を行ってください。  

**・ログファイルを格納せず、または複数件格納して起動**  
必ず1件のログファイルをsrc/log_filesディレクトリ下に格納した状態で起動を行うようにしてください。ログファイルが格納されていなかったり、複数件存在すると正常に動作しません。

